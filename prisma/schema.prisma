generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

model Cast {
  id          String   @id @default(cuid())
  titleId     String
  tmdbId      Int
  name        String
  character   String?
  order       Int
  profilePath String?
  createdAt   DateTime @default(now())
  Title       Title    @relation(fields: [titleId], references: [id], onDelete: Cascade)

  @@index([titleId])
}

model Crew {
  id          String   @id @default(cuid())
  titleId     String
  tmdbId      Int
  name        String
  job         String
  department  String?
  profilePath String?
  createdAt   DateTime @default(now())
  Title       Title    @relation(fields: [titleId], references: [id], onDelete: Cascade)

  @@index([titleId])
}

model CronTask {
  id              String    @id @default(cuid())
  name            String    @unique
  description     String?
  endpoint        String
  method          String    @default("GET")
  intervalMinutes Int       @default(60)
  enabled         Boolean   @default(true)
  lastRunAt       DateTime?
  lastSuccessAt   DateTime?
  lastStatus      Int?
  lastError       String?
  lastDurationMs  Int?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model Episode {
  id               String             @id @default(cuid())
  titleId          String
  seasonId         String
  tmdbId           Int?
  seasonNumber     Int
  episodeNumber    Int
  name             String
  overview         String?
  airDate          DateTime?
  runtime          Int?
  stillUrl         String?
  hlsPath          String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  Season           Season             @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  Title            Title              @relation(fields: [titleId], references: [id], onDelete: Cascade)
  PlaybackProgress PlaybackProgress[]

  @@unique([titleId, seasonNumber, episodeNumber])
  @@index([seasonId])
  @@index([titleId])
}

model Genre {
  id         String       @id @default(cuid())
  tmdbId     Int          @unique
  name       String
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  TitleGenre TitleGenre[]
}

model NotificationPreference {
  id              String   @id @default(cuid())
  userId          String   @unique
  newContent      Boolean  @default(true)
  updates         Boolean  @default(true)
  recommendations Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  User            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Payment {
  id             String       @id @default(cuid())
  subscriptionId String
  asaasPaymentId String       @unique
  status         String
  value          Float
  billingType    String
  dueDate        DateTime
  paymentDate    DateTime?
  invoiceUrl     String?
  pixQrCode      String?
  pixCopiaECola  String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  Subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
}

model PlaybackProgress {
  id              String   @id @default(cuid())
  profileId       String
  titleId         String
  episodeId       String?
  positionSeconds Int
  durationSeconds Int
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  Episode         Episode? @relation(fields: [episodeId], references: [id], onDelete: Cascade)
  Profile         Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  Title           Title    @relation(fields: [titleId], references: [id], onDelete: Cascade)

  @@unique([profileId, episodeId])
  @@unique([profileId, titleId])
  @@index([episodeId])
  @@index([profileId])
  @@index([titleId])
}

model Profile {
  id                 String             @id @default(cuid())
  userId             String
  name               String
  avatar             String?
  isKids             Boolean            @default(false)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  useCloudflareProxy Boolean            @default(false)
  PlaybackProgress   PlaybackProgress[]
  User               User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  UserFavorite       UserFavorite[]

  @@index([userId])
}

model PushToken {
  id         String   @id @default(cuid())
  userId     String
  token      String   @unique
  platform   String   @default("unknown")
  deviceName String?
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  User       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

model Request {
  id               String               @id @default(cuid())
  userId           String
  assignedAdminId  String?
  assignedAt       DateTime?
  imdbId           String?
  title            String
  type             RequestType
  desiredLanguages String?
  desiredQuality   String?
  note             String?
  imdbJson         Json?
  status           RequestStatus        @default(PENDING)
  workflowState    RequestWorkflowState @default(NONE)
  followersCount   Int                  @default(0)
  priorityScore    Float?
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  User             User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  AssignedAdmin    User?                @relation("RequestAssignedAdmin", fields: [assignedAdminId], references: [id])
  RequestFollower  RequestFollower[]
  RequestHistory   RequestHistory[]
  RequestUpload    RequestUpload?

  @@index([createdAt])
  @@index([imdbId])
  @@index([status])
  @@index([type])
  @@index([assignedAdminId])
}

model RequestFollower {
  id        String   @id @default(cuid())
  requestId String
  userId    String
  createdAt DateTime @default(now())
  Request   Request  @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@unique([requestId, userId])
  @@index([requestId])
  @@index([userId])
}

model RequestHistory {
  id        String               @id @default(cuid())
  requestId String
  action    RequestHistoryAction
  message   String?
  adminId   String?
  createdAt DateTime             @default(now())
  Request   Request              @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([requestId])
}

model RequestUpload {
  id          String    @id @default(cuid())
  requestId   String    @unique
  titleId     String?
  completedAt DateTime?
  Request     Request   @relation(fields: [requestId], references: [id], onDelete: Cascade)
  Title       Title?    @relation(fields: [titleId], references: [id])

  @@index([requestId])
  @@index([titleId])
}

model Season {
  id           String    @id @default(cuid())
  titleId      String
  seasonNumber Int
  name         String?
  overview     String?
  airDate      DateTime?
  posterUrl    String?
  episodeCount Int?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  Episode      Episode[]
  Title        Title     @relation(fields: [titleId], references: [id], onDelete: Cascade)

  @@unique([titleId, seasonNumber])
  @@index([titleId])
}

model ServiceStatusSnapshot {
  id         String   @id @default(cuid())
  createdAt  DateTime @default(now())
  healthy    Int
  total      Int
  allHealthy Boolean
  services   Json

  @@index([createdAt])
}

model Settings {
  id                         String   @id @default(cuid())
  siteName                   String   @default("Pflix")
  siteDescription            String   @default("Sua plataforma de streaming")
  maintenanceMode            Boolean  @default(false)
  allowRegistration          Boolean  @default(true)
  maxUploadSize              Int      @default(10)
  transcoderCrf              Int      @default(20)
  deleteSourceAfterTranscode Boolean  @default(true)
  createdAt                  DateTime @default(now())
  updatedAt                  DateTime @updatedAt
}

model Subscription {
  id                  String    @id @default(cuid())
  userId              String    @unique
  status              String
  plan                String    @default("BASIC")
  currentPeriodStart  DateTime?
  currentPeriodEnd    DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  asaasCustomerId     String?
  asaasPaymentId      String?
  asaasSubscriptionId String?
  price               Float     @default(10.00)
  Payment             Payment[]
  User                User      @relation(fields: [userId], references: [id])
}

model Title {
  id                  String             @id @default(cuid())
  tmdbId              Int?               @unique
  type                TitleType
  slug                String             @unique
  name                String
  originalName        String?
  overview            String?
  tagline             String?
  releaseDate         DateTime?
  posterUrl           String?
  backdropUrl         String?
  logoUrl             String?
  hlsPath             String?
  runtime             Int?
  voteAverage         Float?
  voteCount           Int?
  popularity          Float?
  status              String?
  originalLanguage    String?
  spokenLanguages     String?
  productionCountries String?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  Cast                Cast[]
  Crew                Crew[]
  Episode             Episode[]
  PlaybackProgress    PlaybackProgress[]
  RequestUpload       RequestUpload[]
  Season              Season[]
  TitleGenre          TitleGenre[]
  UserFavorite        UserFavorite[]
  Video               Video[]
}

model TitleGenre {
  id        String   @id @default(cuid())
  titleId   String
  genreId   String
  createdAt DateTime @default(now())
  Genre     Genre    @relation(fields: [genreId], references: [id], onDelete: Cascade)
  Title     Title    @relation(fields: [titleId], references: [id], onDelete: Cascade)

  @@unique([titleId, genreId])
}

model User {
  id                     String                  @id @default(cuid())
  email                  String                  @unique
  name                   String?
  avatar                 String?
  passwordHash           String
  role                   UserRole                @default(USER)
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  useCloudflareProxy     Boolean                 @default(false)
  cpfCnpj                String?
  phone                  String?
  approvalStatus         ApprovalStatus          @default(PENDING)
  approvedAt             DateTime?
  approvedBy             String?
  rejectionReason        String?
  NotificationPreference NotificationPreference?
  PasswordResetToken     PasswordResetToken[]
  Profile                Profile[]
  PushToken              PushToken[]
  Request                Request[]
  AssignedRequests       Request[]              @relation("RequestAssignedAdmin")
  Subscription           Subscription?
}

model UserFavorite {
  id        String   @id @default(cuid())
  profileId String
  titleId   String
  createdAt DateTime @default(now())
  Profile   Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  Title     Title    @relation(fields: [titleId], references: [id], onDelete: Cascade)

  @@unique([profileId, titleId])
  @@index([profileId])
  @@index([titleId])
}

model Video {
  id          String    @id @default(cuid())
  titleId     String
  key         String
  name        String
  site        String
  type        String
  official    Boolean   @default(false)
  publishedAt DateTime?
  createdAt   DateTime  @default(now())
  Title       Title     @relation(fields: [titleId], references: [id], onDelete: Cascade)

  @@index([titleId])
}

model EmailLog {
  id               String      @id
  status           EmailStatus
  to               String
  subject          String
  fromEmail        String?
  fromName         String?
  reason           String?
  context          Json?
  providerResponse Json?
  errorMessage     String?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime

  @@index([createdAt])
  @@index([reason])
  @@index([status])
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum RequestHistoryAction {
  CREATED
  FOLLOWED
  STATUS_CHANGED
  WORKFLOW_CHANGED
  ASSIGNED
  REJECTED
  COMPLETED
  LINKED_TO_CATALOG
  NOTE_ADDED
}

enum RequestStatus {
  PENDING
  UNDER_REVIEW
  IN_PRODUCTION
  UPLOADING
  COMPLETED
  REJECTED
}

enum RequestType {
  MOVIE
  SERIES
  ANIME
  DORAMA
  OTHER
}

enum RequestWorkflowState {
  NONE
  TECH_ANALYSIS
  SOURCE_ACQUISITION
  ENCODING
  SUBTITLING
  UPLOAD_SERVER
  PUBLISHED
}

enum TitleType {
  MOVIE
  SERIES
  ANIME
  OTHER
}

enum UserRole {
  USER
  ADMIN
}

enum EmailStatus {
  SUCCESS
  ERROR
}
